<!--
Copyright SecureKey Technologies Inc. All Rights Reserved.

SPDX-License-Identifier: Apache-2.0
 -->
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta charset="utf-8">
    <link rel="icon" type="images/x-icon" href="img/immigration_logo.jpg" >
    <title>Store Digital Green Card</title>
    <meta name="description" content="">
    <meta name="keywords" content="">
    <meta name="author" content="">

    <link rel="stylesheet" href="https://unpkg.com/tailwindcss/dist/tailwind.min.css">
    <!--Replace with your tailwind.css once created-->

    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <script src="https://unpkg.com/credential-handler-polyfill@2.1.1/dist/credential-handler-polyfill.min.js"></script>
    <script src="https://unpkg.com/web-credential-handler@1.0.1/dist/web-credential-handler.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <style>
        .gradient {
            background: linear-gradient(to right, #f0f2f0, #ffffff);
        }
        .cardgradient {
            background: linear-gradient(to right, #1e3c72, #2a5298);
        }
    </style>
</head>
<body class="leading-normal tracking-normal bg-gray-100" onload="getSearchID()">
<div class="bg-red-800 border border-red-400 text-white text-center rounded flex items-center justify-center" role="alert">
    <p class="lg:text-xl md:text-lg sm:text-sm">This is not government site. Do not use real data.</p>
</div>


<div class="flex flex-wrap py-2 shadow-lg bg-white">
    <div class="w-full px-4">
        <nav class="container px-4 mx-auto flex flex-wrap items-center justify-between">
            <div class="w-full relative flex justify-between lg:w-auto px-4 lg:static lg:block lg:justify-start">
                <a href="/applygreencard"><img class="block lg:block h-36 w-auto" src="img/immigration_nav_logo.png"></a>
            </div>
            <div class="flex lg:flex-grow items-center">
                <ul class="flex flex-col lg:flex-row list-none ml-auto">
                    <li class="nav-item">
                        <div class="shadow flex">
                            <input class="w-full rounded p-2 text-lg" type="text" placeholder="Search our Site">
                            <button class="bg-white w-64 flex justify-end items-center text-blue-800 p-2 hover:text-blue-400">
                                <i class="fa fa-search" aria-hidden="true"></i>
                            </button>
                        </div>
                    </li>
                    <li class="nav-item lg:py-2">
                        <!--todo integrate with issuer auth api -->
                        <a href="/" class="text-blue-800 bg-blue-100 border shadow-md font-semibold font-sans lg:text-xl sm:text-lg hover:shadow-lg hover:bg-gray-100 px-4 m-5 py-2 rounded-md text-center font-bold">
                            Sign-In</a>
                    </li>
                </ul>
            </div>
        </nav>
    </div>
    <div class="flex-1 flex lg:justify-end sm:items-stretch sm:justify-start text-blue-800 font-semibold text-xl">
        <div class="sm:block sm:ml-6">
            <div class="flex space-x-4">
                <a href="/" class=" hover:shadow-lg  px-3 py-6 rounded-md ">Forms</a>
            </div>
        </div>
        <div class="sm:block sm:ml-6">
            <div class="flex space-x-4">
                <a href="/" class=" hover:shadow-lg  px-3 py-6 rounded-md">News</a>
            </div>
        </div>
        <div class="sm:block sm:ml-6">
            <div class="flex space-x-4">
                <a href="/" class="hover:shadow-lg  py-6 rounded-md">Citizenship</a>
            </div>
        </div>
        <div class=" sm:block sm:ml-6">
            <div class="flex space-x-4">
                <a href="/" class=" hover:shadow-lg  px-3 py-6 rounded-md">Green Card</a>
            </div>
        </div>
        <div class=" sm:block sm:ml-6">
            <div class="flex space-x-4">
                <a href="/" class="hover:shadow-lg  px-3 py-6 rounded-md">Laws</a>
            </div>
        </div>
        <div class="sm:block sm:ml-6">
            <div class="flex space-x-4 pr-48">
                <a href="/" class="hover:shadow-lg  px-3 py-6 rounded-md">Tools</a>
            </div>
        </div>
    </div>
</div>


<div class="grid grid-rows-3 grid-flow-col gap-4 pt-8 px-48">
    <!--Sidebar-->
    <div class="row-span-3 text-blue-900 bg-white">
        <h1 class="leading-tight px-4 py-4 text-black font-bold gradient border-l-4 border-blue-900"><i class="fa fa-id-card px-4 text-blue-900" aria-hidden="true"></i>
            Green Card</h1>
        <ul class="list-reset flex flex-row md:flex-col text-center md:text-left px-8">
            <li class="mr-3 flex-1">
                <a href="/" class="block py-1 md:py-3 pl-1 align-middle text-gray-800 hover:text-green-400 border-gray-800 md:border-gray-900 hover:border-green-400">
                    <span class="pb-1 md:pb-0 text-xs md:text-base text-gray-600 md:text-gray-400 block md:inline-block"><i class="fa fa-square text-gray-300 px-4 text-lg" aria-hidden="true"></i>Green Card Eligibility</span>
                </a>
            </li>
            <li class="mr-3 flex-1">
                <a href="/" class="block py-1 md:py-3 pl-1 align-middle text-gray-800  hover:text-green-400  border-gray-800 md:border-gray-900 hover:border-green-400">
                    <span class="pb-1 md:pb-0 text-xs md:text-base text-gray-600 md:text-gray-400 block md:inline-block"><i class="fa fa-square text-gray-300 px-4 text-lg" aria-hidden="true"></i>Digital Green Card Application Lookup</span>
                </a>
            </li>
            <li class="mr-3 flex-1">
                <a href="/" class="block py-1 md:py-3 pl-1 align-middle text-gray-800  hover:text-green-400  border-gray-800 md:border-gray-900 hover:border-green-400">
                    <span class="pb-1 md:pb-0 text-xs md:text-base text-gray-600 md:text-gray-400 block md:inline-block"><i class="fa fa-square text-gray-300 px-4 text-lg" aria-hidden="true"></i>How to Apply for Digital Green Card </span>
                </a>
            </li>
            <li class="mr-3 flex-1">
                <a href="/" class="block py-1 md:py-3 pl-1 align-middle border-l-4 border-blue-900 gradient text-black border-gray-800 md:border-gray-900">
                    <span class="pb-1 md:pb-0 text-xs md:text-base font-bold block md:inline-block"><i class="fa fa-square text-gray-300 px-4 text-lg" aria-hidden="true"></i>How to Apply for a Green Card </span>
                </a>
            </li>
            <li class="mr-3 flex-1">
                <a href="/" class="block py-1 md:py-3 pl-1 align-middle text-gray-800  hover:text-green-400  border-gray-800 md:border-gray-900 hover:border-green-400">
                    <span class="pb-1 md:pb-0 text-xs md:text-base text-gray-600 md:text-gray-400 block md:inline-block"><i class="fa fa-square text-gray-300 px-4 text-lg" aria-hidden="true"></i>Green Card Processes and Procedures </span>
                </a>
            </li>
            <li class="mr-3 flex-1">
                <a href="/" class="block py-1 md:py-3 pl-1 align-middle text-gray-800  hover:text-green-400  border-gray-800 md:border-gray-900 hover:border-green-400">
                    <span class="pb-1 md:pb-0 text-xs md:text-base text-gray-600 md:text-gray-400 block md:inline-block"><i class="fa fa-square text-gray-300 px-4 text-lg" aria-hidden="true"></i>Green Card Status with USCIS</span>
                </a>
            </li>
            <li class="mr-3 flex-1">
                <a href="/" class="block py-1 md:py-3 pl-1 align-middle text-gray-800  hover:text-green-400  border-gray-800 md:border-gray-900 hover:border-green-400">
                    <span class="pb-1 md:pb-0 text-xs md:text-base text-gray-600 md:text-gray-400 block md:inline-block"><i class="fa fa-square text-gray-300 px-4 text-lg" aria-hidden="true"></i>After Receiving a Decision </span>
                </a>
            </li>
            <li class="mr-3 flex-1">
                <a href="/" class="block py-1 md:py-3 pl-1 align-middle text-gray-800  hover:text-green-400  border-gray-800 md:border-gray-900 hover:border-green-400">
                    <span class="pb-1 md:pb-0 text-xs md:text-base text-gray-600 md:text-gray-400 block md:inline-block"><i class="fa fa-square text-gray-300 px-4 text-lg" aria-hidden="true"></i>After We grant Your Green Card </span>
                </a>
            </li>
        </ul>
    </div>
    <div class="row-span-3 col-span-2 px-2 py-8" style="display:block" id="connectToWallet">
        <input class=" hidden" id="hiddenID" type="text"/>
        <div class="w-full h-full fixed top-0 left-0 bg-gray-800 opacity-75 z-50" id="loading-screen" style="display:none">
        <span class="text-green-500 my-0 mx-auto block fixed w-0 h-0" style="top: 50%;right: 50%;">
         <i class="fa fa-spinner fa-spin fa-5x"></i>
       </span>
        </div>
        <h4 class="w-full p-4 text-2xl font-bold text-center text-red-500" id="connect-error-board"></h4>
        <h2 class="bold text-5xl px-2">Digital Permanent Resident Card</h2>
        <p class="text-xl font-sans font-bold text-blue-800 px-2 py-8">
            Step 3
        </p>
        <div class="grid grid-cols-2 bg-white border max-w-3xl border-gray-300 py-4">
            <div class="py-8 px-8">
                <label class="block text-xl text-gray-800 font-bold mb-2" for="email">
                    Permanent Resident Card
                </label>
                <label class="block text-sm font-sans text-gray-600 mb-2 py-4" for="email">
                    You can click on Connect to wallet button to connect to wallet, or scan the QR Code to store the resident card.
                </label>
                <a class="bg-blue-800 py-2 px-4 border border-gray-800 hover:bg-green-dark text-white font-bold rounded shadow-lg
                cursor-pointer" type="button" id='authBtn'>
                    Connect To Wallet
                </a>
                <input type="text" id="holder" class="hidden"/>
                <span class="block text-sm py-2 text-gray-400">Or scan QR code in mobile wallet</span>
            </div>
            <div class="px-16">
                <img class="block h-64 w-auto flex" src="img/qrscan.png">
            </div>
        </div>
    </div>
    <div class="row-span-3 col-span-2 px-12 py-8" style="display:none" id="previewDataDiv">
        <h4 class="w-full p-4 text-xl font-bold text-center text-red-500" id="preview-error-board"></h4>
        <h2 class="bold text-4xl py-4">Digital Permanent Resident Card</h2>
        <div class="grid grid-cols-1 bg-white border max-w-xl border-gray-300">
            <div class="grid grid-cols-2 cardgradient shadow-lg rounded bg-white border max-w-xl border-gray-300">
            <div class="px-8 py-4">
                <img class="h-48 rounded-lg " src="img/borat.png">
            </div>
                <div class="px-4 flex items-center grid grid-rows-1 py-8 ">
                    <div class="flex items-center justify-start">
                        <img class="h-16 px-1 rounded-full text-center" src="img/immigration_logo.jpg">
                        <label class="block text-lg text-white font-bold mb-2" for="email">
                            Utopia Permanent Resident Card
                        </label>
                    </div>
                </div>
            </div>
            <div class="py-8 px-8">
                <h2 class="bold text-xl text-center py-4">User Resident Card Details</h2>
                <table class="border-collapse w-full text-black text-left">
                    <tbody id="credential">
                    </tbody>
                </table>
                <textarea id="vcDataTextArea" class="hidden"></textarea>
                <div class="flex-none mt-auto rounded-b rounded-t-none overflow-hidden p-6">
                    <div class="flex items-center justify-center">
                        <a class=" flex items-center justify-center cardgradient py-2 px-4 rounded-full border text-white font-bold rounded shadow-lg cursor-pointer"
                           onclick="storeCredential()" type="button">
                            Save Credential
                        </a>
                    </div>
                </div>
            </div>

        </div>
    </div>
    <div class="row-span-3 col-span-2 px-12 py-24" style="display: none" id="successDiv">
        <div class="grid grid-cols-1 bg-white border max-w-3xl border-gray-300 py-4">
            <div class="text-center">
                <i class="fa fa-check-circle fa-5x text-green-800" aria-hidden="true"></i>
                <label class="block text-lg font-sans text-gray-600 mb-2 py-4 " for="email">
                    Your Digital Permanent Resident Card has been stored successfully.
                </label>
            </div>
        </div>
    </div>
</div>

<div class="py-16">
</div>
<footer class="text-center bg-white">
    <section class="container mx-auto text-center">
        <div class="text-sm text-blue-800 font py-6">
            <img class="object-contain object-top-center h-32 w-full" src="img/immigration_nav_logo.png">
            Copyright &copy; <a href="https://securekey.com/"  class="text-blue-900 hover:text-green-700" rel="nofollow">SecureKey Technologies</a> and the TrustBloc Contributors.
        </div>
    </section>
</footer>
</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script type="text/javascript" src="js/jquery.1.11.1.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>

<script>
    let searchID = document.getElementById("hiddenID").innerHTML;

    function getSearchID(){
        const params = new URLSearchParams(window.location.search);
        searchID = params.get('id');
    }
    function ready(fn) {
        if (document.readyState !== 'loading') {
            fn();
        } else {
            document.addEventListener('DOMContentLoaded', fn);
        }
    }

    ready(() => {
        document.getElementById('authBtn').addEventListener('click', performConnectWallet);
    });

    installHandler()
        .catch(e => console.error('Error in installHandler:', e));

    async function installHandler() {
        console.log('Loading polyfill...');
        try {
            await credentialHandlerPolyfill.loadOnce();
        } catch (e) {
            console.error('Error in loadOnce:', e);
        }
    }

    async function performConnectWallet() {
        document.getElementById("connect-error-board").innerText = "";

        const challenge = uuidv4();
        const domain = window.location.hostname;

        const credentialQuery = {
            web: {
                VerifiablePresentation: {
                    query: {type: "DIDAuth"},
                    challenge: challenge,
                    domain: domain
                }
            }
        };

        console.log("Sending credential query", credentialQuery);

        const result = await navigator.credentials.get(credentialQuery);
        console.log("DID Auth web credential response:", result.data);


        if (!result || !result.data) {
            console.log("Unable to get DID authorization, no response");
            return;
        }

        if (!result.data.holder) {
            console.log("invalid DID auth response, failed to get holder info from response", result.data);
            document.getElementById("connect-error-board").innerText = "Authentication failed, please try again.";
            return;
        }

        let didAuthData = {
            "holder":result.data.holder,
            "domain" :domain,
            "challenge": challenge,
            "didAuthResp": result.data
        };

        axios.post('/verify/didauth',
            didAuthData
        ).then(function (response) {
            document.getElementById("holder").innerText = result.data.holder;
            document.getElementById("connectToWallet").style.display ="none";
            document.getElementById("loading-screen").style.display = "block";
            generateCredential();
            console.log("generate did auth response:", response);
        }).catch(error => {
            console.log(error);
            document.getElementById("connect-error-board").innerText = "Connection to Wallet Failed, please try again.";
        });
    }

    function uuidv4() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
            var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
     }

     function generateCredential() {
        let holder = document.getElementById("holder").innerText;
        let generateCredData = {
             "id": searchID,
             "holder":holder,
             "vcsProfile" : "trustbloc-ed25519signature2018-ed25519"
         };
         axios.post('/credential/generate',
             generateCredData
         ).then(function (response) {
             document.getElementById("previewDataDiv").style.display ="block";
             console.log("generate credential response:", response);
             document.getElementById("vcDataTextArea").value = JSON.stringify(response.data);
             prettyTable(response.data);
             document.getElementById("loading-screen").style.display = "none";
         }).catch(error => {
             console.log(error);
             document.getElementById("connectToWallet").style.display ="block";
             document.getElementById("connect-error-board").innerText = "Failed to Generate Permanent Resident Card. Try Again";
         });
     }

    function flatten(json, flattened) {
        for (var key in json) {
            if (json.hasOwnProperty(key)) {
                if (json[key] instanceof Object && json[key] != "") {
                    flatten(json[key], flattened,  key);
                } else {
                    flattened[key] = json[key];
                }
            }
        }
    }

    function prettyTable(credentialData){
        let flattened = {};
        flatten(credentialData, flattened);
        replaceKeys(flattened);
        for (var key in flattened){
            if (key !== 'undefined'){
                var tbody = document.getElementById('credential');
                var tr = "<tr>";
                if (isNaN(key)){
                    tr += "<td class=\"  w-full lg:w-auto px-3 text-gray-800 text-left text-sm block lg:table-cell relative lg:static\">" + key +
                        "</td>" + "<td class=\" w-full lg:w-auto px-1 text-gray-800 text-left text-lg block lg:table-cell relative lg:static overflow-auto \">" + flattened[key] + "</td></tr>";
                    tbody.innerHTML += tr;
                }
            }

        }
    }

    function getFriendlyKeyName(name) {
        var keys = {
            "type": 'Signature Type',
            "referenceNumber": 'Booking Ref No.',
            "lprNumber": 'LPR Number',
            "birthCountry": 'Country of Birth',
            "familyName" : 'Last Name',
            "birthDate":   'Date of Birth',
            "givenName": 'Given Name',
            "gender":     'Gender',
            "lprCategory" :'LPR Category',
            "residentSince" :'Resident Since',
            "description" :'Description',
            "issuanceDate" :'Date of Issue',
            "name" :'Card',
            "created" :'Date of Creation'
        };
        return keys[name];
    }
    function replaceKeys(json) {
        for (var key in json) {
            var friendlyKeyName =  getFriendlyKeyName(key);
            if (friendlyKeyName !== 'undefined'){
                json[friendlyKeyName] = json[key];
                delete json[key];
            }
        }
    }
    async function storeCredential() {
       let credentialToStore = document.getElementById("vcDataTextArea").value;
       let credentialObject = JSON.parse(credentialToStore);
        console.log('storing prc credential', credentialObject);
        const vp = {
            "@context": [
                "https://www.w3.org/2018/credentials/v1"
            ],
            type: "VerifiablePresentation",
            verifiableCredential: [
                credentialObject
            ]
        };

        // Construct the WebCredential wrapper around the credential to be stored
        const webCredentialWrapper = new WebCredential('VerifiablePresentation', vp);
        // Use Credential Handler API to store
        result = await navigator.credentials.store(webCredentialWrapper);
        console.log('Result of receiving via store() request:', result);
        if (!result) {
            document.getElementById("error-board").innerText = "Failed to issue Permanent Resident Card. Retry";
        } else {
            document.getElementById("successDiv").style.display ="block";
            document.getElementById("previewDataDiv").style.display ="none";
            document.getElementById("connectToWallet").style.display ="none";
        }
    };
    </script>

</html>



